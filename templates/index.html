<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Execute Command</title>
    <style>
        #outputContainer {
            width: 800px;
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
        }
		.model-config {
      		display: none; /* 初始状态设置为隐藏 */
    	}
    </style>
</head>
<body>
	<h1>模型量化转换工具</h1>
	<select id="model_name" name="model_name" onchange="updateDefaultConfig()">
		<option value="resnet18_track_detection">resnet18_track_detection</option>
		<option value="yolov5s-2.0">yolov5s-2.0</option>
		<!-- <option value="01_mobilenet">mobilenetv1</option>
		<option value="04_mobilenet_onnx">mobilenetv2</option>
		<option value="googlenet">googlenet</option>
		<option value="efficientnet_lite0_onnx">efficientnet-lite0</option>
		<option value="efficientnet_lite1_onnx">efficientnet-lite1</option>
		<option value="efficientnet_lite2_onnx">efficientnet-lite2</option>
		<option value="efficientnet_lite3_onnx">efficientnet-lite3</option>
		<option value="efficientnet_lite4_onnx">efficientnet-lite4</option>
		<option value="yolov2_darknet19">yolov2_darknet19</option>
		<option value="yolov3_darknet53">yolov3_darknet53</option>
		<option value="ssd_mobilenetv1">mobilenetv1_ssd</option>
		<option value="efficientdetd0">efficientdetd0</option>
		<option value="centernet_resnet50">centernet_resnet50</option>
		<option value="fcos_efficientnetb0">fcos_efficientnetb0</option>
		<option value="unet_mobilenet">unet_mobilenet</option>
		<option value="deeplabv3plus_efficientnetb0">deeplabv3plus_efficientnetb0</option>
		<option value="fastscnn_efficientnetb0">fastscnn_efficientnetb0</option> -->
	</select>
	<br>
	<select id="has_model" name="has_model" onchange="trainStateChange();updateParameter();converConfigStateChange()">
		<option value="true">已有onnx/caffe模型</option>
		<option value="false">没有onnx/caffe模型</option>
	</select>
	<!-- <br>
	<select id="has_dataset" name="has_dataset" onchange = "updateParameter()">
		<option value="false">没有数据集</option>
		<option value="true">已有数据集</option>
	</select> -->
	<br>
	<form>
		<label for="dimensionType">选择或输入模型尺寸</label>
		<select id="dimensionType" onchange="handleDimensionTypeChange();updateParameter()" >
			<option value="224x224">224x224</option>
			<option value="672x672">672x672</option>
			<option value="custom">自定义</option>
		</select>
		<div id="customDimensions" style="display:none;">
			<label for="customWidth">宽度：</label>
			<input type="number" id="customWidth" placeholder="宽度" onchange="updateParameter()">
			
			<label for="customHeight">高度：</label>
			<input type="number" id="customHeight" placeholder="高度" onchange="updateParameter()">
		</div>
	</form>
	<br>
	<div id="noModelConfig" class="model-config">
		<button id = "annotation" onclick="redirectToAnotherPage()">数据标注</button>
		<br>
		<form id="uploadDataset" enctype='multipart/form-data' method='POST'>
			<label for="profile_pic">选择要上传的数据集文件</label>
			<input type="file" id="dataset_file" name="dataset_file" webkitdirectory onchange ="updateDatasetButtonState()"/>
			<br>
			<input type="button" id = "upload_dataset_button" value="上传数据集" onclick="uploadDataset();updateTrainButtonState()" onchange="updateDatasetButtonState()" disabled>
		</form>
		<label for="epochs">epochs</label>
		<input type="number" id="epochs" placeholder="epochs" value="4" min="2" onchange="updateParameter()">
		<br>
		<label for="batch-size">batch_size</label>
		<input type="number" id="batch_size" placeholder="batch_size" value="8" onchange="updateParameter()">
		<br>
		<button id = "train" onclick="performTask('/train')"  disabled>模型训练</button>
		<button id = "pt2onnx" onclick="performTask('/export')" disabled >转换为onnx模型</button>
		<br>
	</div>

	<div id="withModelConfig">
		<select id="model_type" name="model_type" onchange ="updateModelFileSelectState();updateParameter()">
			<option value="onnx">onnx</option>
			<option value="caffe">caffe</option>
		</select>
		<br>
		<form id="uploadForm" enctype='multipart/form-data' method='POST'>
			<label for="profile_pic">选择要上传的onnx文件</label>
			<input type="file" id="onnx_file" name="onnx_file" accept=".onnx" onchange ="updateButtonState()"/>
			<br>
			<label for="profile_pic">选择要上传的prototxt文件</label>
			<input type="file" id="prototxt_file" name="prototxt_file" accept=".prototxt" onchange ="updateButtonState()" disabled/>
			<br>
			<label for="profile_pic">选择要上传的caffemodel文件</label>
			<input type="file" id="caffemodel_file" name="caffemodel_file" accept=".caffemodel" onchange ="updateButtonState()" disabled/>
			<br>
			<!-- <label for="profile_pic">选择要上传的配置文件</label>
			<input type="file" id="config_file" name="config_file" accept=".yaml" onchange ="updateButtonState()"/>
			<br> -->
			<label for="profile_pic">选择要上传的校准图片文件</label>
			<input type="file" id="image_file" name="image_file" webkitdirectory onchange ="updateButtonState()"/>
			<br>
			<input type="button" id = "upload_button" value="上传文件" onclick="uploadFile()" onchange="updateButtonState()" disabled>
		</form>
	</div>
	<br>
	<!-- 配置参数 -->
	<label for="profile_pic">网络实际执行时的数据格式</label>
	<select id="input_type_rt" name="input_type_rt" onchange ="updateParameter()">
		<option value="nv12">nv12</option>
		<option value="rgb">rgb</option>
		<option value="bgr">bgr</option>
		<option value="yuv444">yuv444</option>
		<option value="gray">gray</option>
		<option value="featuremap">featuremap</option>
	</select>
	<br>
	<label for="profile_pic">网络实际执行时输入的数据排布</label>
	<select id="input_layout_rt" name="input_layout_rt" onchange ="updateParameter()">
		<option value="NHWC">NHWC</option>
		<option value="NCHW">NCHW</option>
		<option value="None">None</option>
	</select>	
	<br>
	<label for="profile_pic">网络训练时输入的数据格式</label>
	<select id="input_type_train" name="input_type_train" onchange ="updateParameter()">
		<option value="rgb">rgb</option>
		<option value="nv12">nv12</option>
		<option value="bgr">bgr</option>
		<option value="yuv444">yuv444</option>
		<option value="gray">gray</option>
		<option value="featuremap">featuremap</option>
	</select>
	<br>
	<label for="profile_pic">网络训练时输入的数据排布</label>	
	<select id="input_layout_train" name="input_layout_train" onchange ="updateParameter()">
		<option value="NCHW">NCHW</option>
		<option value="NHWC">NHWC</option>
		<option value="None">None</option>
	</select>
	<br>
	<label for="profile_pic">网络输入的预处理方法</label>
	<select id="norm_type" name="norm_type" onchange ="updateParameter()">
		<option value="data_mean_and_scale">data_mean_and_scale</option>
		<option value="no_preprocess">no_preprocess</option>
		<option value="data_mean">data_mean</option>
		<option value="data_scale">data_scale</option>
	</select>	
	<input type="text" id="mean_value" placeholder="减去的均值" value="123.675 116.28 103.53" onchange="updateParameter()">
	<input type="text" id="scale_value" placeholder="缩放的比例" value="0.0171248 0.017507 0.0174292" onchange="updateParameter()">
	<br>
	<button onclick="performTask('/convert')">一键转换</button>
	<br>
	<select id="detect_model" name="detect_model" onchange="updateParameter()">
		<option value="quantized_model">使用量化后的int模型</option>
		<option value="original_float_model">使用原生的float模型</option>
	</select>
	<br>
	<!-- <button id = "detect" onclick="performTask('/detect')">模型检测</button> -->
	<button id="detect">模型检测</button>
    <!-- 使用 JavaScript 设置图片的 src，并初始状态不显示 -->
    <img id="imageToShow" style="display: none;" alt="Image to Show">
    <script>
        // JavaScript 代码
        document.getElementById("detect").addEventListener("click", function() {
            // 在按钮点击时，显示图片
			var imageElement = document.getElementById("imageToShow");
    
    // 添加随机参数，以强制浏览器重新加载图片
			var timestamp = new Date().getTime();
			var imageUrl = "{{ url_for('detect') }}?timestamp=" + timestamp;

			imageElement.src = imageUrl;
			imageElement.style.display = "block";
        });
    </script>
	<br>
	<form id="uploadDetectImage" enctype='multipart/form-data' method='POST'>
		<label for="profile_pic">上传一张图片查看推理效果</label>
		<input type="file" id="detect_image_file" name="detect_image_file" accept="image/*" onchange="uploadDetectImage()"/>
		<!-- <input type="button" id = "upload_button" value="上传文件" onclick="uploadFile()" onchange="updateButtonState()" disabled> -->
	</form>
	<br>
	<button onclick="downloadBinModel()">下载bin模型</button>
	<button onclick="downloadAllModel()">下载所有模型</button>
	
    <div id="outputContainer">
        <pre id="output"></pre>
    </div>


	<script>
		function uploadFile() {
		  var form = document.getElementById('uploadForm');
		  var formData = new FormData(form);

		  var xhr = new XMLHttpRequest();
		  xhr.open('POST', '/upload', true);
	
		  xhr.onreadystatechange = function () {
			if (xhr.readyState === 4) {
			  if (xhr.status === 200) {
				// 处理上传成功的情况
				var response = JSON.parse(xhr.responseText);
				document.getElementById('result').innerHTML = 'File uploaded successfully: ' + response.filename;
			  } else {
				// 处理上传失败的情况
				var response = JSON.parse(xhr.responseText);
				document.getElementById('result').innerHTML = 'Upload failed: ' + response.message;
			  }
			}
		  };
	
		  xhr.send(formData);
		}
	</script>

	<script>
		function uploadDataset() {
		var form = document.getElementById('uploadDataset');
		var formData = new FormData(form);

		var xhr = new XMLHttpRequest();
		xhr.open('POST', '/upload', true);

		xhr.onreadystatechange = function () {
			if (xhr.readyState === 4) {
			if (xhr.status === 200) {
				// 处理上传成功的情况
				var response = JSON.parse(xhr.responseText);
				document.getElementById('result').innerHTML = 'File uploaded successfully: ' + response.filename;
			} else {
				// 处理上传失败的情况
				var response = JSON.parse(xhr.responseText);
				document.getElementById('result').innerHTML = 'Upload failed: ' + response.message;
			}
			}
		};

		xhr.send(formData);
		}
	</script>

	<script>
		function uploadDetectImage() {
		var form = document.getElementById('uploadDetectImage');
		var formData = new FormData(form);

		var xhr = new XMLHttpRequest();
		xhr.open('POST', '/upload_detect_image', true);

		xhr.onreadystatechange = function () {
			if (xhr.readyState === 4) {
			if (xhr.status === 200) {
				// 处理上传成功的情况
				var response = JSON.parse(xhr.responseText);
				document.getElementById('result').innerHTML = 'File uploaded successfully: ' + response.filename;
			} else {
				// 处理上传失败的情况
				var response = JSON.parse(xhr.responseText);
				document.getElementById('result').innerHTML = 'Upload failed: ' + response.message;
			}
			}
		};

		xhr.send(formData);
		}
	</script>

	<script>
		function updateDefaultConfig(){
			var model_name = document.getElementById('model_name').value

			if(model_name == 'resnet18_track_detection'){
				document.getElementById('input_type_rt').value = 'nv12';
				document.getElementById('input_layout_rt').value = 'None';
				document.getElementById('input_type_train').value = 'rgb';
				document.getElementById('input_layout_train').value = 'NCHW';
				document.getElementById('norm_type').value = 'data_mean_and_scale';
				document.getElementById('mean_value').value = '123.675 116.28 103.53';
				document.getElementById('scale_value').value = '0.0171248 0.017507 0.0174292';
				document.getElementById('dimensionType').value = '224x224';
			} else if (model_name == 'yolov5s-2.0'){
				document.getElementById('input_type_rt').value = 'nv12';
				document.getElementById('input_layout_rt').value = 'None';
				document.getElementById('input_type_train').value = 'rgb';
				document.getElementById('input_layout_train').value = 'NCHW';
				document.getElementById('norm_type').value = 'data_scale';
				document.getElementById('mean_value').value = '';
				document.getElementById('scale_value').value = '0.003921568627451';
				document.getElementById('dimensionType').value = '672x672';
			}
			updateParameter();
		}
	</script>

	<script>
		function updateTrainButtonState(){
			var train = document.getElementById('train');
			var pt2onnx = document.getElementById('pt2onnx');
			train.disabled = false;
			pt2onnx.disabled = false;
		}
	</script>

	<script>
		function converConfigStateChange(){
			var has_model = document.getElementById('has_model').value;
			var input_type_train = document.getElementById('input_type_train');
			var input_layout_train = document.getElementById('input_layout_train');
			var norm_type = document.getElementById('norm_type');
			var mean_value = document.getElementById('mean_value');
			var scale_value = document.getElementById('scale_value');
			if(has_model == "true"){
				input_type_train.disabled = false;
				input_layout_train.disabled = false;
				norm_type.disabled = false;
				mean_value.disabled = false;
				scale_value.disabled = false;
			} else {
				input_type_train.disabled = true;
				input_layout_train.disabled = true;	
				norm_type.disabled = true;
				mean_value.disabled = true;
				scale_value.disabled = true;
			}
		}
	</script>

    {% with messages = get_flashed_messages() %}
         {% if messages %}
               {% for message in messages %}
                    <p>{{ message }}</p>
               {% endfor %}
         {% endif %}
    {% endwith %}
	<p>{{ check_log }}</p>
	
	<script>
        function updateDatasetButtonState() {
			var dataset_file_input = document.getElementById('dataset_file');
			var uploadDatasetButton = document.getElementById('upload_dataset_button');
            uploadDatasetButton.disabled = !dataset_file_input.files.length;
        }
    </script>

	<script>
        function updateParameter() {
			var dimensionType = document.getElementById('dimensionType').value;
			var customWidth = document.getElementById('customWidth').value;
			var customHeight = document.getElementById('customHeight').value;
			var model_name = document.getElementById('model_name').value;
			var model_type = document.getElementById('model_type').value;

			var input_type_rt = document.getElementById('input_type_rt').value;
			var input_layout_rt = document.getElementById('input_layout_rt').value;
			var input_type_train = document.getElementById('input_type_train').value;
			var input_layout_train = document.getElementById('input_layout_train').value;
			var norm_type = document.getElementById('norm_type').value;

			var has_model = document.getElementById('has_model').value;
			// var has_dataset = document.getElementById('has_dataset').value;

			var mean_value = document.getElementById('mean_value').value;
			var scale_value = document.getElementById('scale_value').value;

			var epochs = document.getElementById('epochs').value;
			var batch_size = document.getElementById('batch_size').value

			var detect_model = document.getElementById('detect_model').value
			var xhr = new XMLHttpRequest();
			xhr.open('POST', '/update_parameter', true);
			xhr.setRequestHeader('Content-Type', 'application/json');
			var data = {
				dimensionType: dimensionType,
				model_name: model_name,
				customWidth: customWidth,
				customHeight: customHeight,
				model_type: model_type,
				
				input_type_rt: input_type_rt,
				input_layout_rt:input_layout_rt,
				input_type_train: input_type_train,
				input_layout_train: input_layout_train,
				norm_type: norm_type,
				has_model: has_model,
				// has_dataset: has_dataset,

				mean_value: mean_value,
				scale_value: scale_value,
				
				epochs: epochs,
				batch_size: batch_size,
				detect_model: detect_model
			};
			var jsonData = JSON.stringify(data);
			xhr.onreadystatechange = function() {
				if (xhr.readyState === 4 && xhr.status === 200) {
					console.log('Backend parameter updated successfully.');
				}
			};
			xhr.send(jsonData);
        }
    </script>

	<script>
		function trainStateChange() {
			var has_model = document.getElementById("has_model");
			var noModelConfig = document.getElementById("noModelConfig");
			var withModelConfig = document.getElementById("withModelConfig");
			if(has_model.value == "true"){
				noModelConfig.style.display = "none";
       			withModelConfig.style.display = "block";
			} else {
				noModelConfig.style.display = "block";
        		withModelConfig.style.display = "none";
			}
		}
	</script>



	<script>
        function updateModelFileSelectState() {
			var selectedValue = document.getElementById("model_type").value;
			var onnx_file_input = document.getElementById('onnx_file');
			var prototxt_file_input = document.getElementById('prototxt_file');
			var caffemodel_file_input = document.getElementById('caffemodel_file');
			if(selectedValue == "onnx"){
				onnx_file_input.disabled = false;
				prototxt_file_input.disabled = true;
				caffemodel_file_input.disabled = true;
			} else {
				prototxt_file_input.disabled = false;
				caffemodel_file_input.disabled = false;
				onnx_file_input.disabled = true;
			}
        }
    </script>

	<script>
		function handleDimensionTypeChange() {
			var dimensionType = document.getElementById('dimensionType').value;
			var customDimensionsDiv = document.getElementById('customDimensions');
		
			// 如果用户选择了 "自定义"，显示自定义输入框，否则隐藏
			if (dimensionType == 'custom') {
				customDimensionsDiv.style.display = 'block';
			} else {
				customDimensionsDiv.style.display = 'none';
			}
		}
	</script>

    <script>
        function performTask(route) {
            // 使用JavaScript的Fetch API进行异步请求
            fetch(route, {
                method: 'POST',
            })
            .then(response => response.json())
            .catch(error => console.error('Error:', error));
        }
    </script>

	<script>
        function updateButtonState() {
			var onnx_file_input = document.getElementById('onnx_file');
			var prototxt_file_input = document.getElementById('prototxt_file');
			var caffemodel_file_input = document.getElementById('caffemodel_file');
			// var config_file_input = document.getElementById('config_file');
			var image_file_input = document.getElementById('image_file');

			var uploadButton = document.getElementById('upload_button');

            // 如果文件输入框有选择文件，则启用按钮；否则禁用按钮

            uploadButton.disabled = !(((onnx_file_input.files.length || (prototxt_file_input && caffemodel_file_input)) && image_file_input.files.length));
			// uploadButton.disabled = !model_file_input.files.length
        }
    </script>

    <script>
        function downloadBinModel() {
            // 向 Flask 路由发送 GET 请求以触发文件下载
            window.location.href = '/download_bin_model';
        }
    </script>
    <script>
        function downloadAllModel() {
            // 向 Flask 路由发送 GET 请求以触发文件下载
            window.location.href = '/download_all_model';
        }
    </script>
	<script>
		function redirectToAnotherPage() {
			// 在这里设置跳转的目标页面的 URL
			window.open("http://localhost:8080", '_blank');
		}
	</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <script>
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('output', function(data) {
            document.getElementById('output').textContent += data;
        });
		socket.on('clear_output', function() {
        document.getElementById('output').textContent = '';
    	});
    </script>

</body>
</html>

